name: PR Checks

on:
  pull_request:
    branches: [ master, develop ]
    types: [opened, synchronize, reopened]

jobs:
  # Quick smoke tests for PR validation
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_nami
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
          frontend/node_modules
          ai-service/node_modules
        key: ${{ runner.os }}-pr-smoke-${{ hashFiles('backend/go.sum', 'backend/migrations/go.sum', 'frontend/package-lock.json', 'ai-service/package-lock.json') }}

    - name: Install dependencies
      run: |
        cd backend && go mod download
        cd backend/migrations && go mod download
        cd frontend && npm ci
        cd ai-service && npm ci

    - name: Check formatting
      run: |
        cd backend && if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then echo "Go code is not formatted:"; gofmt -s -l .; exit 1; fi
        cd backend/migrations && if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then echo "Migration code is not formatted:"; gofmt -s -l .; exit 1; fi

    - name: Backend quick tests
      run: |
        cd backend && go test -short ./... -race
      env:
        DATABASE_URL: postgres://test_user:test_password@localhost:5432/test_nami?sslmode=disable

    - name: Frontend type check
      working-directory: ./frontend
      run: npm run lint:ts

    - name: AI Service type check
      working-directory: ./ai-service
      run: npm run check

    - name: Check build
      run: |
        cd backend && go build -o ../bin/test-backend ./cmd/server
        cd frontend && npm run build
        cd ai-service && npm run build

  # Detect breaking changes
  breaking-changes:
    name: Breaking Changes Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for API changes
      run: |
        # Check for changes in Go API handlers
        if git diff --name-only origin/${{ github.base_ref }} HEAD | grep -E "(backend/internal/handlers|backend/cmd)"; then
          echo "⚠️  API changes detected - please ensure backward compatibility"
        fi

    - name: Check for database schema changes
      run: |
        # Check for changes in migration files
        if git diff --name-only origin/${{ github.base_ref }} HEAD | grep -E "migrations/.*\.sql"; then
          echo "⚠️  Database schema changes detected - ensure proper migration handling"
        fi

    - name: Check for frontend API usage changes
      run: |
        # Check for changes in API service layer
        if git diff --name-only origin/${{{ github.base_ref }}} HEAD | grep -E "frontend/src/(api|services)"; then
          echo "⚠️  Frontend API layer changes detected - ensure compatibility with backend"
        fi

  # Performance regression check
  performance:
    name: Performance Regression Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Run Go benchmarks
      run: |
        cd backend && go test -bench=. -benchmem ./... -run=^$ 2>/dev/null || echo "No benchmarks found"

    - name: Check bundle size
      run: |
        cd frontend && npm run build
        # Check if bundle size is reasonable (adjust thresholds as needed)
        BUILD_SIZE=$(du -k dist | cut -f1)
        if [ $BUILD_SIZE -gt 5000 ]; then
          echo "⚠️  Frontend bundle size is large: ${BUILD_SIZE}KB"
        fi